"$schema": https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json
name: Raven
scopeName: "source.raven"
patterns:
  - include: '#block'
  - include: '#macros'
  - include: '#expressions'
repository:
  comments:
    patterns:
      - name: comment.block.raven
        begin: '#\|'
        end: '\|#'
        patterns:
          - include: '#comments'
      - name: comment.line.raven
        match: '#.*$'

  strings:
    patterns:
      - name: string.quoted.double.raven
        begin: '(\\*)"'
        beginCaptures:
          0: { name: punctuation.definition.string.begin.raven }
        end: '"\1'
        endCaptures:
          0: { name: punctuation.definition.string.end.raven }
        patterns:
          - name: constant.character.escape.raven
            match: '\\(0|t|n|r|"|''|\\)'
      - name: string.quoted.raw.raven
        begin: '(\\*)`'
        beginCaptures:
          0: { name: punctuation.definition.string.begin.raven }
        end: '`\1'
        endCaptures:
          0: { name: punctuation.definition.string.end.raven }

  annotations:
    patterns:
      - name: support.meta.annotation.raven
        match: '@([A-Za-z_][A-Za-z0-9_!?]*)'
        captures:
          2: { name: support.modifier.annotation.raven }

  keywords:
    patterns:
      - name: keyword.control.raven
        match: '\b(break|continue|return)\b(?![!?])'
      - name: constant.language.raven
        match: '\b(true|false|nil)\b(?![!?])'

  expressions:
    patterns:
      - include: '#comments'
      - include: '#strings'
      - include: '#annotations'
      - include: '#keywords'
      - include: '#numbers'
      - include: '#idents'
      - include: '#operators'
      - include: '#punctuation'

  macros:
    patterns:
      - name: meta.macro.raven
        begin: '([_A-Za-z][._A-Za-z0-9]*)\s+(?=[\{\[\(\"`_A-Za-z0-9])'
        beginCaptures:
          1: { name: keyword.other.macro.raven }
        end: '(?=,|\)|\}|$)'
        patterns:
          - include: '#block'
          - include: '#expressions'

  block:
    patterns:
      - begin: '[\{\(\[]'
        beginCaptures:
          0: { name: punctuation.section.brackets.begin.raven }
        end: '\0'
        endCaptures:
          0: { name: punctuation.section.brackets.begin.raven }
        patterns:
          - include: '#block'
          - include: '#macros'
          - include: '#expressions'

  numbers:
    patterns:
      - name: constant.numeric.hex.raven
        match: '(?<!\w)-?0x[0-9A-Fa-f]+'
      - name: constant.numeric.float.raven
        match: '(?<!\w)-?(?:\d+\.\d*|\d*\.\d+)'
      - name: constant.numeric.integer.raven
        match: '(?<!\w)-?\d+'

  operators:
    patterns:
      - name: keyword.operator.logical.raven
        match: '\|\||&&'
      - name: keyword.operator.pipeline.raven
        match: '\|>'
      - name: keyword.operator.comparison.raven
        match: '==|!=|>=|<=|>|<'
      - name: keyword.operator.assignment.raven
        match: '='
      - name: keyword.operator.bitwise.raven
        match: '\||&'
      - name: keyword.operator.arithmetic.raven
        match: '\+|-|\*|/|\^|:'
      - name: punctuation.accessor.raven
        match: '\.'

  punctuation:
    patterns:
      - name: punctuation.separator.sequence.raven
        match: ','

  idents:
    patterns:
      - name: variable.other.member.raven
        match: '(?<=\.)[A-Za-z_][A-Za-z0-9_!?]*'
      - name: variable.language.special.raven
        match: '(&)([A-Za-z_][A-Za-z0-9_!?]*)'
        captures:
          1: { name: keyword.definition.variable.special.raven }
          2: { name: variable.language.special.raven }
      - name: variable.other.raven
        match: '[A-Za-z_][A-Za-z0-9_!?]*'
